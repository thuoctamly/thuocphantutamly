<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n tr·ªã D·ªØ li·ªáu T√¢m l√Ω (Admin Pro)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* ================================================================= */
        /* 1. CSS C∆† B·∫¢N & LAYOUT                                           */
        /* ================================================================= */
        :root { --bg: #f4f7fb; --primary: #004080; --white: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background-color: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Toolbar */
        .toolbar { padding: 15px 20px; background: white; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 300px; font-size: 14px; }
        button.btn-export { padding: 10px 15px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button.btn-export:hover { background: #219150; }

        /* B·∫£ng D·ªØ li·ªáu Ch√≠nh (Database View) */
        .table-container { flex: 1; overflow: auto; padding: 20px; }
        table.main-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        table.main-table th { background: #004080; color: white; padding: 12px; text-align: left; position: sticky; top: 0; font-size: 13px; text-transform: uppercase; }
        table.main-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
        table.main-table tr:hover { background-color: #f0f7ff; cursor: pointer; }
        
        /* Tr·∫°ng th√°i Badge */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; display: inline-block; }
        .bg-purple { background: #e1bee7; color: #4a148c; }
        .bg-red { background: #ffcdd2; color: #b71c1c; }
        .bg-green { background: #c8e6c9; color: #1b5e20; }
        .bg-blue { background: #bbdefb; color: #0d47a1; }
        .bg-amber { background: #ffecb3; color: #ff6f00; }
        .bg-gray { background: #f5f5f5; color: #666; }

        /* ================================================================= */
        /* 2. CSS MODAL (C·ª¨A S·ªî CHI TI·∫æT) - GI·∫¢I QUY·∫æT V·∫§N ƒê·ªÄ ƒê√à L√äN NHAU   */
        /* ================================================================= */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #f4f7fb; margin: 2% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 900px; height: 90%; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal-header { padding: 15px 20px; background: #004080; color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .close-btn { color: white; font-size: 24px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #ccc; }

        /* Th√¥ng tin Profile trong Modal */
        .profile-box { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #004080; display: flex; flex-wrap: wrap; gap: 20px; }
        .profile-item { flex: 1; min-width: 150px; }
        .profile-label { font-size: 12px; color: #666; font-weight: bold; text-transform: uppercase; }
        .profile-value { font-size: 16px; color: #333; font-weight: 500; }

        /* ================================================================= */
        /* 3. CSS CHO CARD NH·∫¨T K√ù (COPY T·ª™ INDEX.HTML ƒê·ªÇ ƒê·ªíNG B·ªò)          */
        /* ================================================================= */
        .cycle-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; overflow: hidden; border: 1px solid #e1e4e8; }
        .card-header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-header strong { font-size: 16px; }
        
        /* B·∫£ng Log chi ti·∫øt b√™n trong Card */
        .log-container { max-height: 200px; overflow-y: auto; border-bottom: 1px solid #eee; background: #ffffff; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .log-table th { position: sticky; top: 0; color: white; padding: 8px; font-weight: 500; text-align: left; }
        .log-table td { padding: 8px; border-bottom: 1px solid #f1f1f1; color: #333; }
        .log-table tr:nth-child(even) { background-color: #fcfcfc; }

        /* Ph·∫ßn Feedback */
        .feedback-area { padding: 16px; background-color: #fdfdfd; }
        .saved-data { background: #eef9f0; border: 1px solid #c3e6cb; padding: 12px; border-radius: 8px; color: #333; }
        .saved-item { margin-bottom: 8px; font-size: 14px; }
        .saved-label { font-weight: bold; color: #155724; display: block; margin-bottom: 2px;}

        /* M√†u s·∫Øc theo tr·∫°ng th√°i (Gi·ªëng index.html) */
        .color-purple .card-header { background: #f3e5f5; border-bottom: 2px solid #8e44ad; }
        .color-purple .card-header strong { color: #8e44ad !important; }
        .color-purple .log-table th { background: #8e44ad; }
        
        .color-red .card-header { background: #ffebee; border-bottom: 2px solid #e74c3c; }
        .color-red .card-header strong { color: #e74c3c !important; }
        .color-red .log-table th { background: #e74c3c; }

        .color-green .card-header { background: #e8f5e9; border-bottom: 2px solid #2ecc71; }
        .color-green .card-header strong { color: #2ecc71 !important; }
        .color-green .log-table th { background: #2ecc71; }

        .color-blue .card-header { background: #e3f2fd; border-bottom: 2px solid #2980b9; }
        .color-blue .card-header strong { color: #2980b9 !important; }
        .color-blue .log-table th { background: #2980b9; }

        .color-amber .card-header { background: #fff8e1; border-bottom: 2px solid #FFD700; }
        .color-amber .card-header strong { color: #d4ac0d !important; } /* V√†ng ƒë·∫≠m h∆°n cho ch·ªØ d·ªÖ ƒë·ªçc */
        .color-amber .log-table th { background: #FFD700; color: #333; }
        
        /* Stars & Emoji static display */
        .star-static { color: #f1c40f; font-size: 16px; }
        .star-gray { color: #ddd; }
    </style>
</head>
<body>

    <header>
        <h1>üîê Admin - Trung t√¢m Gi√°m s√°t T√¢m l√Ω</h1>
        <div style="font-size:12px; opacity: 0.8;">Phi√™n b·∫£n Qu·∫£n l√Ω D·ªØ li·ªáu T·∫≠p trung</div>
    </header>
<div style="background: #fff; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
    <div style="display:flex; flex-direction: column; gap: 5px;">
        <label style="font-weight: bold; font-size: 13px; color: #333;">üìÖ Th·ªùi ƒëi·ªÉm B·∫Øt ƒë·∫ßu Chu k·ª≥:</label>
        <input type="datetime-local" id="sysStartTime" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
    
    <div style="display:flex; flex-direction: column; gap: 5px;">
        <label style="font-weight: bold; font-size: 13px; color: #333;">‚è≥ Kho·∫£ng th·ªùi gian (Ph√∫t):</label>
        <input type="number" id="sysDuration" placeholder="V√≠ d·ª•: 10080 (1 tu·∫ßn)" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
        <small style="color: #666; font-size: 11px;">(1 tu·∫ßn = 10080 ph√∫t)</small>
    </div>

    <button onclick="updateSystemConfig()" style="padding: 10px 20px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 40px;">
        üöÄ THI·∫æT L·∫¨P & ƒê·ªíNG B·ªò TO√ÄN H·ªÜ TH·ªêNG
    </button>
    <div id="sysMsg" style="color: green; font-weight: bold; margin-left: 10px; display: none;">‚úÖ ƒê√£ c·∫≠p nh·∫≠t!</div>
</div>
    <div class="toolbar">
        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="üîç T√¨m ki·∫øm t√™n, l·ªõp, ID...">
        <button class="btn-export" onclick="downloadCSV()">‚¨á Xu·∫•t B√°o C√°o Excel (CSV)</button>
    </div>

    <div class="table-container">
        <table class="main-table" id="userTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">M√£ ID ‚¨ç</th>
                    <th onclick="sortTable(1)">H·ªç v√† T√™n ‚¨ç</th>
                    <th onclick="sortTable(2)">ƒê·ªëi t∆∞·ª£ng ‚¨ç</th>
                    <th>Th√¥ng tin chi ti·∫øt</th>
                    <th onclick="sortTable(4)">L·∫ßn cu·ªëi ‚¨ç</th>
                    <th onclick="sortTable(5)">Tr·∫°ng th√°i ‚¨ç</th>
                    <th onclick="sortTable(6)" style="text-align:center;">S·ªë chu k·ª≥ ‚¨ç</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr><td colspan="7" style="text-align:center; padding:20px;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin:0; font-size:18px;" id="modalTitle">Chi ti·∫øt H·ªì s∆°</h2>
                <span class="close-btn" onclick="closeModal()">√ó</span>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
        </div>
    </div>

    <script>
        // =================================================================
        // 1. C·∫§U H√åNH FIREBASE
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBvSBloHwRCvWNzt37ThhxuPqVqgQfohlo",
            authDomain: "freudruler.firebaseapp.com",
            databaseURL: "https://freudruler-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "freudruler",
            storageBucket: "freudruler.firebasestorage.app",
            messagingSenderId: "907969291678",
            appId: "1:907969291678:web:e0e99eb6550a31bd42a28f"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();


// --- LOGIC C·∫¨P NH·∫¨T C·∫§U H√åNH H·ªÜ TH·ªêNG ---
const configRef = db.ref('system_config');

// 1. Load c·∫•u h√¨nh hi·ªán t·∫°i khi m·ªü Admin
configRef.on('value', (snap) => {
    const conf = snap.val();
    if(conf) {
        // Chuy·ªÉn timestamp v·ªÅ ƒë·ªãnh d·∫°ng input datetime-local
        if(conf.startTime) {
            const d = new Date(conf.startTime);
            // C·∫ßn ƒë·ªãnh d·∫°ng yyyy-MM-ddThh:mm (ch·ªânh m√∫i gi·ªù cho ƒë√∫ng VN)
            const pad = (n) => n < 10 ? '0'+n : n;
            const localIso = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
            document.getElementById('sysStartTime').value = localIso;
        }
        if(conf.durationMinutes) {
            document.getElementById('sysDuration').value = conf.durationMinutes;
        }
    }
});

// 2. H√†m G·ª≠i c·∫•u h√¨nh m·ªõi
function updateSystemConfig() {
    const tVal = document.getElementById('sysStartTime').value;
    const dVal = document.getElementById('sysDuration').value;

    if(!tVal || !dVal) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Th·ªùi gian b·∫Øt ƒë·∫ßu v√† Kho·∫£ng th·ªùi gian!");
        return;
    }

    const startTs = new Date(tVal).getTime();
    const durationMs = parseInt(dVal) * 60 * 1000; // ƒê·ªïi ph√∫t ra mili gi√¢y

    if(confirm("C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω RESET chu k·ª≥ c·ªßa T·∫§T C·∫¢ ng∆∞·ªùi d√πng v·ªÅ th·ªùi ƒëi·ªÉm b·∫°n ch·ªçn. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) {
        configRef.set({
            startTime: startTs,
            durationMs: durationMs, // L∆∞u th·∫≥ng ms cho client d·ªÖ t√≠nh
            durationMinutes: parseInt(dVal),
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            const msg = document.getElementById('sysMsg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        });
    }
}
        const usersRef = db.ref('users');

        let usersData = []; // L∆∞u tr·ªØ m·∫£ng user ƒë·ªÉ x·ª≠ l√Ω

        // =================================================================
        // 2. X·ª¨ L√ù D·ªÆ LI·ªÜU & RENDER B·∫¢NG CH√çNH
        // =================================================================
        
        // Chu·∫©n h√≥a lo·∫°i ng∆∞·ªùi d√πng (Student/Resident -> Ti·∫øng Vi·ªát)
        function normalizeUserType(type) {
            if (!type) return 'Ch∆∞a x√°c ƒë·ªãnh';
            const t = type.toLowerCase();
            if (t.includes('student') || t.includes('h·ªçc sinh')) return 'H·ªçc sinh';
            if (t.includes('resident') || t.includes('ng∆∞·ªùi d√¢n')) return 'Ng∆∞·ªùi d√¢n';
            return 'Kh√°c';
        }

        // L·∫•y danh s√°ch Users t·ª´ Firebase
        usersRef.on('value', (snapshot) => {
            const data = snapshot.val();
            usersData = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    const u = data[key];
                    u.id = key;
                    
                    // Chu·∫©n h√≥a l·ªãch s·ª≠ (history l√† m·∫£ng m·ªõi, cycles l√† object c≈©)
                    if (u.history && Array.isArray(u.history)) {
                        u.processedHistory = u.history;
                    } else if (u.cycles) {
                        // Convert object cycles c≈© sang m·∫£ng
                        u.processedHistory = Object.keys(u.cycles).map(k => {
                            const c = u.cycles[k];
                            // C·ªë g·∫Øng l·∫•y timestamp t·ª´ key ho·∫∑c data
                            c.endTime = c.endTime || parseInt(k) || Date.now();
                            c.avgScore = (c.currentState && c.currentState.score) ? c.currentState.score : 0;
                            return c;
                        }).sort((a,b) => b.endTime - a.endTime);
                    } else {
                        u.processedHistory = [];
                    }

                    // L·∫•y tr·∫°ng th√°i m·ªõi nh·∫•t
                    if (u.processedHistory.length > 0) {
                        const last = u.processedHistory[0]; // M·ªõi nh·∫•t ƒë·∫ßu ti√™n
                        u.lastDate = last.endTime;
                        u.lastScore = last.avgScore;
                    } else {
                        u.lastDate = 0;
                        u.lastScore = null;
                    }
                    
                    usersData.push(u);
                });
                renderTable(usersData);
            } else {
                document.getElementById('userTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            }
        });

        function renderTable(list) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            list.forEach(user => {
                const p = user.profile || {};
                const type = normalizeUserType(p.userType);
                let detail = '';
                if (type === 'H·ªçc sinh') detail = `${p.className || ''} - ${p.schoolName || ''}`;
                else if (type === 'Ng∆∞·ªùi d√¢n') detail = `${p.phone || ''} - ${p.address || ''}`;
                else detail = `${p.birthYear || ''}`;

                // Format ng√†y
                const dateStr = user.lastDate ? new Date(user.lastDate).toLocaleDateString('vi-VN') : '--';
                
                // Badge tr·∫°ng th√°i
                let badge = '<span class="badge bg-gray">Ch∆∞a c√≥</span>';
                if (user.lastScore !== null) {
                    const s = user.lastScore;
                    if (s <= -6667) badge = `<span class="badge bg-purple">B·∫£n nƒÉng m·∫°nh (${s.toFixed(1)})</span>`;
                    else if (s <= -3334) badge = `<span class="badge bg-red">B·∫£n nƒÉng v·ª´a (${s.toFixed(1)})</span>`;
                    else if (s >= 6667) badge = `<span class="badge bg-amber">Si√™u ng√£ m·∫°nh (${s.toFixed(1)})</span>`;
                    else if (s >= 3334) badge = `<span class="badge bg-blue">Si√™u ng√£ v·ª´a (${s.toFixed(1)})</span>`;
                    else badge = `<span class="badge bg-green">C√¢n b·∫±ng (${s.toFixed(1)})</span>`;
                }

                const tr = document.createElement('tr');
                tr.onclick = () => showDetail(user.id);
                tr.innerHTML = `
                    <td style="font-family:monospace; color:#555;">${user.id.substring(0,8)}...</td>
                    <td style="font-weight:bold; color:#004080;">${p.fullName || '·∫®n danh'}</td>
                    <td>${type}</td>
                    <td>${detail}</td>
                    <td>${dateStr}</td>
                    <td>${badge}</td>
                    <td style="text-align:center; font-weight:bold;">${user.processedHistory.length}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // =================================================================
        // 3. LOGIC HI·ªÇN TH·ªä CHI TI·∫æT (PORT T·ª™ INDEX.HTML SHOWREVIEW)
        // =================================================================
        
        // Helpers
        function getCategoryInfo(val) {
            const n = Number(val || 0);
            if (n <= -6667) return { label: 'B·∫£n nƒÉng m·∫°nh', emoji: 'üòà', class: 'color-purple', color: '#8e44ad' };
            if (n <= -3334) return { label: 'B·∫£n nƒÉng v·ª´a',  emoji: 'üî•', class: 'color-red', color: '#e74c3c' };
            if (n >= 6667)  return { label: 'Si√™u ng√£ m·∫°nh',  emoji: 'üòá', class: 'color-amber', color: '#FFD700' };
            if (n >= 3334)  return { label: 'Si√™u ng√£ v·ª´a',   emoji: 'üïäÔ∏è', class: 'color-blue', color: '#2980b9' };
            return { label: 'C√¢n b·∫±ng', emoji: 'üë§', class: 'color-green', color: '#2ecc71' };
        }

        function renderStars(val) {
            let h = '';
            for(let i=1; i<=5; i++) h += (i<=val ? '‚òÖ' : '‚òÜ');
            return `<span class="star-static">${h}</span> <small>(${val || 0}/5)</small>`;
        }
        
        function renderEmoji(val) {
            const emojis = ['üò°', '‚òπÔ∏è', 'üòê', 'üôÇ', 'üòç'];
            if (!val || val < 1) return '--';
            return emojis[val-1];
        }

        function formatDateTime(ts) {
            if(!ts) return {time:'', date:''};
            const d = new Date(ts);
            return {
                time: d.toLocaleTimeString('vi-VN', {hour12:false}),
                date: d.toLocaleDateString('vi-VN')
            };
        }

        // H√†m Show Detail Modal
        function showDetail(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;

            const p = user.profile || {};
            const type = normalizeUserType(p.userType);

            // 1. Render Header Profile
            document.getElementById('modalTitle').textContent = `H·ªì s∆°: ${p.fullName || 'Kh√¥ng t√™n'} (${userId})`;
            
            let profileHTML = `
                <div class="profile-box">
                    <div class="profile-item"><div class="profile-label">H·ªç v√† T√™n</div><div class="profile-value">${p.fullName || '--'}</div></div>
                    <div class="profile-item"><div class="profile-label">Gi·ªõi t√≠nh</div><div class="profile-value">${p.gender || '--'}</div></div>
                    <div class="profile-item"><div class="profile-label">ƒê·ªëi t∆∞·ª£ng</div><div class="profile-value" style="color:#004080;">${type}</div></div>
            `;
            
            if(type === 'H·ªçc sinh'){
                profileHTML += `
                    <div class="profile-item"><div class="profile-label">L·ªõp</div><div class="profile-value">${p.className || '--'}</div></div>
                    <div class="profile-item"><div class="profile-label">Tr∆∞·ªùng</div><div class="profile-value">${p.schoolName || '--'}</div></div>
                `;
            } else {
                profileHTML += `
                    <div class="profile-item"><div class="profile-label">SƒêT</div><div class="profile-value">${p.phone || '--'}</div></div>
                    <div class="profile-item"><div class="profile-label">ƒê·ªãa ch·ªâ</div><div class="profile-value">${p.address || '--'}</div></div>
                `;
            }
            profileHTML += `</div>`;

            // 2. Render Nh·∫≠t K√Ω Cycles (QUAN TR·ªåNG: Full detail nh∆∞ showReview)
            let historyHTML = '';
            
            if (user.processedHistory.length === 0) {
                historyHTML = '<div style="text-align:center; padding:30px; color:#888;">Ch∆∞a c√≥ d·ªØ li·ªáu ph·∫£n t∆∞ n√†o.</div>';
            } else {
                // Duy·ªát qua t·ª´ng chu k·ª≥
                user.processedHistory.forEach((cycle, index) => {
                    const cycleNum = user.processedHistory.length - index;
                    const avgScore = cycle.avgScore;
                    const catInfo = getCategoryInfo(avgScore);
                    const startObj = formatDateTime(cycle.startTime || cycle.endTime); 
                    const fb = cycle.feedback || {};

                    // Card Wrapper v·ªõi class m√†u
                    historyHTML += `<div class="cycle-card ${catInfo.class}">`;
                    
                    // Header Card
                    historyHTML += `
                        <div class="card-header">
                            <div class="header-left">
                                <strong>Chu k·ª≥ ${cycleNum}</strong> 
                                <span style="font-size:13px; color:#555; font-weight:normal;">(Ghi nh·∫≠n: ${startObj.time} ${startObj.date})</span>
                            </div>
                            <div class="header-right">
                                <span style="font-size:18px; font-weight:bold;">${catInfo.emoji} ${avgScore > 0 ? '+' : ''}${Number(avgScore).toFixed(1)}</span>
                            </div>
                        </div>
                    `;

                    // B·∫£ng Log (Entries) - ƒê√É B·ªî SUNG
                    historyHTML += `<div class="log-container"><table class="log-table">
                        <thead><tr><th>Th·ªùi gian</th><th>ƒêi·ªÉm</th><th>Khuynh h∆∞·ªõng</th></tr></thead>
                        <tbody>`;
                    
                    const entries = cycle.entries || [];
                    if (entries.length === 0) {
                        historyHTML += `<tr><td colspan="3" style="text-align:center; padding:10px; color:#999;">Kh√¥ng c√≥ d·ªØ li·ªáu log chi ti·∫øt</td></tr>`;
                    } else {
                        entries.forEach(e => {
                            const val = Number(e.value || 0);
                            const info = getCategoryInfo(val);
                            // L·∫•y m√†u ri√™ng cho t·ª´ng d√≤ng log
                            const valColor = info.color;
                            const tStr = e.time || (e.ts ? formatDateTime(e.ts).time : '--');
                            const dStr = e.date || (e.ts ? formatDateTime(e.ts).date : '--');
                            
                            historyHTML += `
                                <tr>
                                    <td><strong>${tStr}</strong> <span style="color:#888; font-size:11px;">${dStr}</span></td>
                                    <td style="font-weight:bold; color:${valColor}">${val > 0 ? '+' : ''}${val}</td>
                                    <td>${info.emoji} ${info.label}</td>
                                </tr>
                            `;
                        });
                    }
                    historyHTML += `</tbody></table></div>`;

                    // Ph·∫ßn Ph·∫£n t∆∞ (Feedback)
                    historyHTML += `<div class="feedback-area">`;
                    if (fb && (fb.q1 || fb.content)) { // Support c·∫£ data c≈© (content) v√† m·ªõi (q1,q2,q3)
                         historyHTML += `
                            <div class="saved-data">
                                <div style="margin-bottom:8px; border-bottom:1px solid #c3e6cb; padding-bottom:5px; color:#155724;">‚úÖ <b>D·ªØ li·ªáu Ph·∫£n t∆∞</b></div>
                                
                                <div class="saved-item"><span class="saved-label">üìù S·ª± ki·ªán ƒë√°ng nh·ªõ:</span> ${fb.q1 || fb.content || '--'}</div>
                                <div class="saved-item"><span class="saved-label">‚öîÔ∏è Xung ƒë·ªôt n·ªôi t√¢m:</span> ${fb.q2 || '--'}</div>
                                <div class="saved-item"><span class="saved-label">üí° B√†i h·ªçc r√∫t ra:</span> ${fb.q3 || '--'}</div>
                                
                                <hr style="border-top:1px dashed #abc; margin:10px 0;">
                                
                                <div style="display:flex; flex-wrap:wrap; gap:15px;">
                                    <div class="saved-item">üì± Giao di·ªán: ${renderStars(fb.r1)}</div>
                                    <div class="saved-item">üß† Hi·ªÉu b·∫£n th√¢n: ${renderStars(fb.r2)}</div>
                                    <div class="saved-item">ü¶ã Thay ƒë·ªïi HV: ${renderStars(fb.r3)}</div>
                                </div>
                                <div style="margin-top:6px; padding-top:6px; border-top:1px dotted #c3e6cb; display:flex; gap:20px;">
                                    <div class="saved-item">üòä H√†i l√≤ng KQ: <b>${renderEmoji(fb.satResult)}</b></div>
                                    <div class="saved-item">üìè H√†i l√≤ng Th∆∞·ªõc: <b>${renderEmoji(fb.satTool)}</b></div>
                                </div>
                            </div>
                         `;
                    } else {
                        historyHTML += `<div style="padding:10px; border:1px dashed #ccc; text-align:center; color:#777; border-radius:6px; background:#f9f9f9;">Ng∆∞·ªùi d√πng ch∆∞a vi·∫øt nh·∫≠t k√Ω cho chu k·ª≥ n√†y.</div>`;
                    }
                    historyHTML += `</div></div>`; // End card
                });
            }

            // Render v√†o Modal
            document.getElementById('modalBody').innerHTML = profileHTML + `<h3 style="color:#004080; border-bottom:2px solid #eee; padding-bottom:10px;">üìú L·ªãch s·ª≠ Ho·∫°t ƒë·ªông</h3>` + historyHTML;
            document.getElementById('detailModal').style.display = "block";
        }

        // Modal Logic
        function closeModal() {
            document.getElementById('detailModal').style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == document.getElementById('detailModal')) {
                closeModal();
            }
        }

        // =================================================================
        // 4. SORT & SEARCH & EXPORT
        // =================================================================
        let sortCol = -1;
        let sortAsc = true;

        function sortTable(colIndex) {
            sortAsc = (sortCol === colIndex) ? !sortAsc : true;
            sortCol = colIndex;

            usersData.sort((a, b) => {
                let v1, v2;
                const pA = a.profile || {};
                const pB = b.profile || {};
                
                switch(colIndex) {
                    case 0: v1 = a.id; v2 = b.id; break;
                    case 1: v1 = pA.fullName || ''; v2 = pB.fullName || ''; break;
                    case 2: v1 = normalizeUserType(pA.userType); v2 = normalizeUserType(pB.userType); break;
                    case 4: v1 = a.lastDate || 0; v2 = b.lastDate || 0; break;
                    case 5: v1 = a.lastScore || 0; v2 = b.lastScore || 0; break;
                    case 6: v1 = a.processedHistory.length; v2 = b.processedHistory.length; break;
                    default: return 0;
                }

                if (v1 < v2) return sortAsc ? -1 : 1;
                if (v1 > v2) return sortAsc ? 1 : -1;
                return 0;
            });
            renderTable(usersData);
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = usersData.filter(u => {
                const p = u.profile || {};
                const searchStr = `${u.id} ${p.fullName} ${p.className} ${p.schoolName} ${p.phone} ${p.address}`.toLowerCase();
                return searchStr.includes(term);
            });
            renderTable(filtered);
        }

        function downloadCSV() {
            let csv = "\uFEFFID,H·ªç t√™n,Lo·∫°i,Chi ti·∫øt,Ng√†y cu·ªëi,ƒêi·ªÉm cu·ªëi,S·ªë chu k·ª≥\n";
            usersData.forEach(u => {
                const p = u.profile || {};
                const type = normalizeUserType(p.userType);
                let detail = type === 'H·ªçc sinh' ? (p.className + ' - ' + p.schoolName) : (p.phone + ' - ' + p.address);
                const date = u.lastDate ? new Date(u.lastDate).toLocaleDateString() : '';
                
                // Escape CSV quotes
                const clean = (txt) => `"${(txt || '').toString().replace(/"/g, '""')}"`;
                csv += `${clean(u.id)},${clean(p.fullName)},${clean(type)},${clean(detail)},${date},${u.lastScore || ''},${u.processedHistory.length}\n`;
            });
            
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            saveAs(blob, "DuLieu_TamLy_Admin.csv");
        }
    </script>
</body>
</html>